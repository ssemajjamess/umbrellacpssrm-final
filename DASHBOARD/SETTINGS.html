<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Umbrella Claims & Property Solutions - Settings</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,700" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-family: 'Roboto', sans-serif;
            min-height: 100vh;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 280px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 24px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e1e5e9;
            margin-bottom: 20px;
        }

        .company-logo {
            max-width: 200px;
            height: auto;
            margin-bottom: 15px;
        }

        .company-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .user-info {
            font-size: 0.9rem;
            color: #666;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: #333;
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 0 25px 25px 0;
            margin-right: 10px;
        }

        .nav-link:hover,
        .nav-link.active {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            transform: translateX(5px);
        }

        .nav-link i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
        }

        .settings-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .settings-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .settings-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .settings-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30, 60, 114, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #fd7e14);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e3c72;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e1e5e9;
        }

        .color-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-picker input[type="color"] {
            width: 50px;
            height: 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }

        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .notification.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .notification.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .notification.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .backup-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .backup-date {
            font-size: 0.9rem;
            color: #666;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3c72;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 20px;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img src="../LOGOS/PNG File-01.png" alt="Umbrella Claims Logo" class="company-logo">
                <div class="company-name">Umbrella Claims & Property Solutions</div>
                <div class="user-info" id="userInfo">Loading...</div>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="DASHBOARD.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="customers.html" class="nav-link">
                        <i class="fas fa-users"></i>
                        Customers
                    </a>
                </li>
                <li class="nav-item">
                    <a href="NEW LEAD.html" class="nav-link">
                        <i class="fas fa-plus-circle"></i>
                        New Lead
                    </a>
                </li>
                <li class="nav-item">
                    <a href="CALENDAR.html" class="nav-link">
                        <i class="fas fa-calendar-alt"></i>
                        Calendar
                    </a>
                </li>
                <li class="nav-item">
                    <a href="INVOICE MANAGEMENT.html" class="nav-link">
                        <i class="fas fa-file-invoice-dollar"></i>
                        Invoices
                    </a>
                </li>
                <li class="nav-item">
                    <a href="API INTEGRATION.html" class="nav-link">
                        <i class="fas fa-plug"></i>
                        API Integration
                    </a>
                </li>
                <li class="nav-item">
                    <a href="CREATE A TASK.html" class="nav-link">
                        <i class="fas fa-tasks"></i>
                        Create Task
                    </a>
                </li>
                <li class="nav-item">
                    <a href="REMINDER.html" class="nav-link">
                        <i class="fas fa-bell"></i>
                        Reminders
                    </a>
                </li>
                <li class="nav-item">
                    <a href="../ACCOUNT SETTINGS/ACCOUNT SETTINGS.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        Account Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="SETTINGS.html" class="nav-link active">
                        <i class="fas fa-sliders-h"></i>
                        System Settings
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        Sign Out
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="settings-header">
                <h1 class="settings-title">
                    <i class="fas fa-sliders-h"></i>
                    System Settings
                </h1>
                <p class="settings-subtitle">Configure every aspect of your CRM system</p>
            </div>

            <!-- Notifications -->
            <div id="notification" class="notification"></div>

            <!-- Data Statistics -->
            <div class="settings-card">
                <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i>
                    Data Statistics
                </h2>
                <div class="data-stats" id="dataStats">
                    <!-- Stats will be loaded here -->
                </div>
            </div>

            <!-- General Settings -->
            <div class="settings-grid">
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-cog"></i>
                        General Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Company Name</label>
                        <input type="text" id="companyName" class="form-input" placeholder="Enter company name">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Default Sales Person</label>
                        <select id="defaultSalesPerson" class="form-select">
                            <option value="">Select default sales person</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Default Insurance Company</label>
                        <select id="defaultInsurance" class="form-select">
                            <option value="">Select default insurance</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Currency</label>
                        <select id="currency" class="form-select">
                            <option value="USD">USD ($)</option>
                            <option value="EUR">EUR (€)</option>
                            <option value="GBP">GBP (£)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Time Zone</label>
                        <select id="timezone" class="form-select">
                            <option value="America/New_York">Eastern Time</option>
                            <option value="America/Chicago">Central Time</option>
                            <option value="America/Denver">Mountain Time</option>
                            <option value="America/Los_Angeles">Pacific Time</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" onclick="saveGeneralSettings()">
                        <i class="fas fa-save"></i>
                        Save General Settings
                    </button>
                </div>

                <!-- User Management -->
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-users"></i>
                        User Management
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Add New User</label>
                        <input type="text" id="newUserName" class="form-input" placeholder="User name">
                        <input type="email" id="newUserEmail" class="form-input" placeholder="Email" style="margin-top: 10px;">
                        <select id="newUserRole" class="form-select" style="margin-top: 10px;">
                            <option value="Owner">Owner</option>
                            <option value="Sales">Sales</option>
                            <option value="Manager">Manager</option>
                            <option value="User">User</option>
                        </select>
                        <button class="btn btn-success" onclick="addNewUser()" style="margin-top: 10px;">
                            <i class="fas fa-plus"></i>
                            Add User
                        </button>
                    </div>

                    <div id="usersList">
                        <!-- Users will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Workflow Settings -->
            <div class="settings-grid">
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-project-diagram"></i>
                        Workflow Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Default Stage for New Leads</label>
                        <select id="defaultStage" class="form-select">
                            <option value="LEAD">LEAD</option>
                            <option value="WAITING ADJUSTMENT">WAITING ADJUSTMENT</option>
                            <option value="WAITING INS SCOPE">WAITING INS SCOPE</option>
                            <option value="READY TO INSTALL">READY TO INSTALL</option>
                            <option value="INVOICED WPAYMENT">INVOICED WPAYMENT</option>
                            <option value="CLOSED-W NEW ROOF">CLOSED-W NEW ROOF</option>
                            <option value="CLOSED-DEAD DENIED">CLOSED-DEAD DENIED</option>
                            <option value="WAITING FEE">WAITING FEE</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto-assign to Sales Person</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="autoAssignSales">
                            <label for="autoAssignSales">Automatically assign new leads to sales person</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto-notify on Stage Change</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="autoNotifyStage">
                            <label for="autoNotifyStage">Send notifications when stage changes</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Require Claim Number</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="requireClaimNumber">
                            <label for="requireClaimNumber">Require claim number for certain stages</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveWorkflowSettings()">
                        <i class="fas fa-save"></i>
                        Save Workflow Settings
                    </button>
                </div>

                <!-- Notification Settings -->
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-bell"></i>
                        Notification Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Email Notifications</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="emailNewLead">
                            <label for="emailNewLead">New lead notifications</label>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="emailStageChange">
                            <label for="emailStageChange">Stage change notifications</label>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="emailTaskDue">
                            <label for="emailTaskDue">Task due date notifications</label>
                        </div>
                        <div class="form-checkbox">
                            <input type="checkbox" id="emailWeeklyReport">
                            <label for="emailWeeklyReport">Weekly report emails</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Browser Notifications</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="browserNotifications">
                            <label for="browserNotifications">Enable browser notifications</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Notification Sound</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="notificationSound">
                            <label for="notificationSound">Play sound for notifications</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveNotificationSettings()">
                        <i class="fas fa-save"></i>
                        Save Notification Settings
                    </button>
                </div>
            </div>

            <!-- Data Management -->
            <div class="settings-grid">
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-database"></i>
                        Data Management
                    </h2>
                    
                    <div class="backup-section">
                        <div class="backup-info">
                            <span>Last Backup</span>
                            <span class="backup-date" id="lastBackupDate">Never</span>
                        </div>
                        <button class="btn btn-success" onclick="createBackup()">
                            <i class="fas fa-download"></i>
                            Create Backup
                        </button>
                        <button class="btn btn-info" onclick="restoreBackup()">
                            <i class="fas fa-upload"></i>
                            Restore Backup
                        </button>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto Backup</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="autoBackup">
                            <label for="autoBackup">Automatically backup data daily</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Data Retention (days)</label>
                        <input type="number" id="dataRetention" class="form-input" value="365" min="30" max="3650">
                    </div>

                    <button class="btn btn-danger" onclick="clearAllData()">
                        <i class="fas fa-trash"></i>
                        Clear All Data
                    </button>
                </div>

                <!-- Appearance Settings -->
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-palette"></i>
                        Appearance Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select id="theme" class="form-select">
                            <option value="light">Light Theme</option>
                            <option value="dark">Dark Theme</option>
                            <option value="auto">Auto (System)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Primary Color</label>
                        <div class="color-picker">
                            <input type="color" id="primaryColor" value="#1e3c72">
                            <span>Customize primary color</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Font Size</label>
                        <select id="fontSize" class="form-select">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Show Animations</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="showAnimations" checked>
                            <label for="showAnimations">Enable smooth animations</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveAppearanceSettings()">
                        <i class="fas fa-save"></i>
                        Save Appearance Settings
                    </button>
                </div>
            </div>

            <!-- Advanced Settings -->
            <div class="settings-grid">
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-tools"></i>
                        Advanced Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">Debug Mode</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="debugMode">
                            <label for="debugMode">Enable debug mode (shows console logs)</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto Save Interval (seconds)</label>
                        <input type="number" id="autoSaveInterval" class="form-input" value="30" min="10" max="300">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Max File Upload Size (MB)</label>
                        <input type="number" id="maxFileSize" class="form-input" value="10" min="1" max="100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Session Timeout (minutes)</label>
                        <input type="number" id="sessionTimeout" class="form-input" value="60" min="15" max="480">
                    </div>

                    <button class="btn btn-warning" onclick="resetToDefaults()">
                        <i class="fas fa-undo"></i>
                        Reset to Defaults
                    </button>
                </div>

                <!-- API Settings -->
                <div class="settings-card">
                    <h2 class="card-title">
                        <i class="fas fa-plug"></i>
                        API Settings
                    </h2>
                    
                    <div class="form-group">
                        <label class="form-label">API Key</label>
                        <input type="text" id="apiKey" class="form-input" placeholder="Enter API key">
                    </div>

                    <div class="form-group">
                        <label class="form-label">API Endpoint</label>
                        <input type="url" id="apiEndpoint" class="form-input" placeholder="https://api.example.com">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Enable API Integration</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="enableAPI">
                            <label for="enableAPI">Enable external API integration</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Auto Sync</label>
                        <div class="form-checkbox">
                            <input type="checkbox" id="autoSync">
                            <label for="autoSync">Automatically sync data with external systems</label>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="saveAPISettings()">
                        <i class="fas fa-save"></i>
                        Save API Settings
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="crm-data.js"></script>
    <script>
        // Initialize CRM
        let crm = null;
        try {
            crm = new UmbrellaCRM();
            console.log('CRM initialized successfully');
        } catch (error) {
            console.error('Error initializing CRM:', error);
        }

        // Check authentication
        const isLoggedIn = localStorage.getItem('userLoggedIn');
        if (isLoggedIn !== 'true') {
            window.location.href = '../index.html';
        }

        // Load settings
        function loadSettings() {
            try {
                // Load general settings
                document.getElementById('companyName').value = localStorage.getItem('companyName') || 'Umbrella Claims & Property Solutions';
                document.getElementById('defaultSalesPerson').value = localStorage.getItem('defaultSalesPerson') || '';
                document.getElementById('defaultInsurance').value = localStorage.getItem('defaultInsurance') || '';
                document.getElementById('currency').value = localStorage.getItem('currency') || 'USD';
                document.getElementById('timezone').value = localStorage.getItem('timezone') || 'America/New_York';

                // Load workflow settings
                document.getElementById('defaultStage').value = localStorage.getItem('defaultStage') || 'LEAD';
                document.getElementById('autoAssignSales').checked = localStorage.getItem('autoAssignSales') === 'true';
                document.getElementById('autoNotifyStage').checked = localStorage.getItem('autoNotifyStage') === 'true';
                document.getElementById('requireClaimNumber').checked = localStorage.getItem('requireClaimNumber') === 'true';

                // Load notification settings
                document.getElementById('emailNewLead').checked = localStorage.getItem('emailNewLead') === 'true';
                document.getElementById('emailStageChange').checked = localStorage.getItem('emailStageChange') === 'true';
                document.getElementById('emailTaskDue').checked = localStorage.getItem('emailTaskDue') === 'true';
                document.getElementById('emailWeeklyReport').checked = localStorage.getItem('emailWeeklyReport') === 'true';
                document.getElementById('browserNotifications').checked = localStorage.getItem('browserNotifications') === 'true';
                document.getElementById('notificationSound').checked = localStorage.getItem('notificationSound') === 'true';

                // Load appearance settings
                document.getElementById('theme').value = localStorage.getItem('theme') || 'light';
                document.getElementById('primaryColor').value = localStorage.getItem('primaryColor') || '#1e3c72';
                document.getElementById('fontSize').value = localStorage.getItem('fontSize') || 'medium';
                document.getElementById('showAnimations').checked = localStorage.getItem('showAnimations') !== 'false';

                // Load advanced settings
                document.getElementById('debugMode').checked = localStorage.getItem('debugMode') === 'true';
                document.getElementById('autoSaveInterval').value = localStorage.getItem('autoSaveInterval') || '30';
                document.getElementById('maxFileSize').value = localStorage.getItem('maxFileSize') || '10';
                document.getElementById('sessionTimeout').value = localStorage.getItem('sessionTimeout') || '60';

                // Load API settings
                document.getElementById('apiKey').value = localStorage.getItem('apiKey') || '';
                document.getElementById('apiEndpoint').value = localStorage.getItem('apiEndpoint') || '';
                document.getElementById('enableAPI').checked = localStorage.getItem('enableAPI') === 'true';
                document.getElementById('autoSync').checked = localStorage.getItem('autoSync') === 'true';

                // Load data management settings
                document.getElementById('autoBackup').checked = localStorage.getItem('autoBackup') === 'true';
                document.getElementById('dataRetention').value = localStorage.getItem('dataRetention') || '365';

                // Load last backup date
                const lastBackup = localStorage.getItem('lastBackupDate');
                if (lastBackup) {
                    document.getElementById('lastBackupDate').textContent = new Date(lastBackup).toLocaleString();
                }

                // Populate dropdowns
                populateDropdowns();
                loadDataStats();
                loadUsersList();

                showNotification('Settings loaded successfully', 'success');
            } catch (error) {
                console.error('Error loading settings:', error);
                showNotification('Error loading settings', 'error');
            }
        }

        // Populate dropdowns
        function populateDropdowns() {
            try {
                if (crm && crm.data) {
                    // Populate sales person dropdown
                    const salesPersonSelect = document.getElementById('defaultSalesPerson');
                    salesPersonSelect.innerHTML = '<option value="">Select default sales person</option>';
                    crm.data.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.name;
                        option.textContent = user.name;
                        salesPersonSelect.appendChild(option);
                    });

                    // Populate insurance dropdown
                    const insuranceSelect = document.getElementById('defaultInsurance');
                    insuranceSelect.innerHTML = '<option value="">Select default insurance</option>';
                    crm.data.insuranceCompanies.forEach(company => {
                        const option = document.createElement('option');
                        option.value = company;
                        option.textContent = company;
                        insuranceSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating dropdowns:', error);
            }
        }

        // Load data statistics
        function loadDataStats() {
            try {
                if (crm && crm.data) {
                    const stats = {
                        customers: crm.data.leads.length,
                        tasks: crm.data.tasks.length,
                        documents: crm.data.documents.length,
                        activities: crm.data.activities.length
                    };

                    const statsContainer = document.getElementById('dataStats');
                    statsContainer.innerHTML = `
                        <div class="stat-item">
                            <div class="stat-number">${stats.customers}</div>
                            <div class="stat-label">Customers</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.tasks}</div>
                            <div class="stat-label">Tasks</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.documents}</div>
                            <div class="stat-label">Documents</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">${stats.activities}</div>
                            <div class="stat-label">Activities</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading data stats:', error);
            }
        }

        // Load users list
        function loadUsersList() {
            try {
                if (crm && crm.data) {
                    const usersContainer = document.getElementById('usersList');
                    usersContainer.innerHTML = '<h3>Current Users</h3>';
                    
                    crm.data.users.forEach(user => {
                        const userDiv = document.createElement('div');
                        userDiv.style.cssText = 'padding: 10px; border: 1px solid #e1e5e9; border-radius: 5px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center;';
                        userDiv.innerHTML = `
                            <div>
                                <strong>${user.name}</strong> (${user.role})
                                <br><small>${user.email}</small>
                            </div>
                            <button class="btn btn-danger" onclick="removeUser('${user.email}')" style="padding: 5px 10px; font-size: 12px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        `;
                        usersContainer.appendChild(userDiv);
                    });
                }
            } catch (error) {
                console.error('Error loading users list:', error);
            }
        }

        // Save functions
        function saveGeneralSettings() {
            try {
                localStorage.setItem('companyName', document.getElementById('companyName').value);
                localStorage.setItem('defaultSalesPerson', document.getElementById('defaultSalesPerson').value);
                localStorage.setItem('defaultInsurance', document.getElementById('defaultInsurance').value);
                localStorage.setItem('currency', document.getElementById('currency').value);
                localStorage.setItem('timezone', document.getElementById('timezone').value);
                
                showNotification('General settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving general settings:', error);
                showNotification('Error saving general settings', 'error');
            }
        }

        function saveWorkflowSettings() {
            try {
                localStorage.setItem('defaultStage', document.getElementById('defaultStage').value);
                localStorage.setItem('autoAssignSales', document.getElementById('autoAssignSales').checked);
                localStorage.setItem('autoNotifyStage', document.getElementById('autoNotifyStage').checked);
                localStorage.setItem('requireClaimNumber', document.getElementById('requireClaimNumber').checked);
                
                showNotification('Workflow settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving workflow settings:', error);
                showNotification('Error saving workflow settings', 'error');
            }
        }

        function saveNotificationSettings() {
            try {
                localStorage.setItem('emailNewLead', document.getElementById('emailNewLead').checked);
                localStorage.setItem('emailStageChange', document.getElementById('emailStageChange').checked);
                localStorage.setItem('emailTaskDue', document.getElementById('emailTaskDue').checked);
                localStorage.setItem('emailWeeklyReport', document.getElementById('emailWeeklyReport').checked);
                localStorage.setItem('browserNotifications', document.getElementById('browserNotifications').checked);
                localStorage.setItem('notificationSound', document.getElementById('notificationSound').checked);
                
                showNotification('Notification settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving notification settings:', error);
                showNotification('Error saving notification settings', 'error');
            }
        }

        function saveAppearanceSettings() {
            try {
                localStorage.setItem('theme', document.getElementById('theme').value);
                localStorage.setItem('primaryColor', document.getElementById('primaryColor').value);
                localStorage.setItem('fontSize', document.getElementById('fontSize').value);
                localStorage.setItem('showAnimations', document.getElementById('showAnimations').checked);
                
                showNotification('Appearance settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving appearance settings:', error);
                showNotification('Error saving appearance settings', 'error');
            }
        }

        function saveAPISettings() {
            try {
                localStorage.setItem('apiKey', document.getElementById('apiKey').value);
                localStorage.setItem('apiEndpoint', document.getElementById('apiEndpoint').value);
                localStorage.setItem('enableAPI', document.getElementById('enableAPI').checked);
                localStorage.setItem('autoSync', document.getElementById('autoSync').checked);
                
                showNotification('API settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving API settings:', error);
                showNotification('Error saving API settings', 'error');
            }
        }

        // Data management functions
        function createBackup() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    data: crm.data,
                    version: '1.0'
                };
                
                const backupStr = JSON.stringify(backup);
                const blob = new Blob([backupStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `umbrella-crm-backup-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                localStorage.setItem('lastBackupDate', new Date().toISOString());
                document.getElementById('lastBackupDate').textContent = new Date().toLocaleString();
                
                showNotification('Backup created successfully', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('Error creating backup', 'error');
            }
        }

        function restoreBackup() {
            try {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const backup = JSON.parse(e.target.result);
                            if (confirm('This will replace all current data. Are you sure?')) {
                                crm.data = backup.data;
                                crm.saveData();
                                showNotification('Backup restored successfully', 'success');
                                loadDataStats();
                            }
                        } catch (error) {
                            console.error('Error restoring backup:', error);
                            showNotification('Invalid backup file', 'error');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            } catch (error) {
                console.error('Error restoring backup:', error);
                showNotification('Error restoring backup', 'error');
            }
        }

        function clearAllData() {
            if (confirm('This will permanently delete all data. Are you absolutely sure?')) {
                try {
                    localStorage.removeItem('umbrellaCRM');
                    crm.initializeData();
                    showNotification('All data cleared', 'success');
                    loadDataStats();
                } catch (error) {
                    console.error('Error clearing data:', error);
                    showNotification('Error clearing data', 'error');
                }
            }
        }

        // User management functions
        function addNewUser() {
            try {
                const name = document.getElementById('newUserName').value;
                const email = document.getElementById('newUserEmail').value;
                const role = document.getElementById('newUserRole').value;
                
                if (!name || !email) {
                    showNotification('Please fill in all fields', 'error');
                    return;
                }
                
                const newUser = {
                    id: Date.now(),
                    name: name,
                    email: email,
                    role: role,
                    phone: ''
                };
                
                crm.data.users.push(newUser);
                crm.saveData();
                
                // Clear form
                document.getElementById('newUserName').value = '';
                document.getElementById('newUserEmail').value = '';
                document.getElementById('newUserRole').value = 'User';
                
                loadUsersList();
                populateDropdowns();
                showNotification('User added successfully', 'success');
            } catch (error) {
                console.error('Error adding user:', error);
                showNotification('Error adding user', 'error');
            }
        }

        function removeUser(email) {
            if (confirm('Are you sure you want to remove this user?')) {
                try {
                    crm.data.users = crm.data.users.filter(user => user.email !== email);
                    crm.saveData();
                    loadUsersList();
                    populateDropdowns();
                    showNotification('User removed successfully', 'success');
                } catch (error) {
                    console.error('Error removing user:', error);
                    showNotification('Error removing user', 'error');
                }
            }
        }

        // Utility functions
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function resetToDefaults() {
            if (confirm('This will reset all settings to default values. Continue?')) {
                try {
                    // Clear all settings
                    const settingsKeys = [
                        'companyName', 'defaultSalesPerson', 'defaultInsurance', 'currency', 'timezone',
                        'defaultStage', 'autoAssignSales', 'autoNotifyStage', 'requireClaimNumber',
                        'emailNewLead', 'emailStageChange', 'emailTaskDue', 'emailWeeklyReport',
                        'browserNotifications', 'notificationSound', 'theme', 'primaryColor', 'fontSize',
                        'showAnimations', 'debugMode', 'autoSaveInterval', 'maxFileSize', 'sessionTimeout',
                        'apiKey', 'apiEndpoint', 'enableAPI', 'autoSync', 'autoBackup', 'dataRetention'
                    ];
                    
                    settingsKeys.forEach(key => localStorage.removeItem(key));
                    
                    // Reload settings
                    loadSettings();
                    showNotification('Settings reset to defaults', 'success');
                } catch (error) {
                    console.error('Error resetting settings:', error);
                    showNotification('Error resetting settings', 'error');
                }
            }
        }

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', function() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                window.location.href = '../index.html';
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });
    </script>
</body>
</html> 